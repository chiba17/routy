<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Routy | Task Manager</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.7/dayjs.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.7/locale/ja.min.js" crossorigin="anonymous"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web" crossorigin="anonymous"></script>

    <!-- Firebase SDK (Compat Version) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Inter"', '"Noto Sans JP"', 'sans-serif'],
                    },
                    colors: {
                        bg: '#F1F5F9',
                        surface: '#FFFFFF',
                        headerBg: '#334155',
                        headerText: '#F8FAFC',
                        primary: '#3B82F6',    
                        text: { main: '#1E293B', sub: '#64748B', muted: '#94A3B8' },
                        accent: { goal: '#F59E0B', today: '#0EA5E9' },
                        border: '#CBD5E1',
                    },
                    boxShadow: {
                        'soft': '0 2px 8px rgba(0, 0, 0, 0.04)',
                        'card': '0 1px 2px 0 rgba(0, 0, 0, 0.05)',
                        'memo': '0 2px 4px rgba(0, 0, 0, 0.05)',
                    }
                }
            }
        }
        dayjs.locale('ja');
    </script>

    <style>
        [v-cloak] { display: none; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94A3B8; }

        body { 
            background-color: #F1F5F9;
            color: #1E293B;
            overscroll-behavior-y: none;
            font-size: 13px;
            -webkit-font-smoothing: antialiased;
        }
        
        .sticky-top-area { position: sticky; top: 0; z-index: 30; background-color: #F8FAFC; }
        .sticky-date { position: sticky; left: 0; z-index: 20; border-right: 1px solid #CBD5E1; }

        .task-card {
            transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
            cursor: grab;
            background: #FFFFFF;
            border: 1px solid #E2E8F0; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .task-card:active { cursor: grabbing; transform: scale(0.99); }
        .task-card:hover {
            z-index: 10;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-color: #94A3B8;
        }

        .sortable-ghost {
            opacity: 0.8;
            background-color: #EFF6FF !important; 
            border: 2px dashed #3B82F6 !important; 
            box-shadow: none !important;
            color: transparent !important;
        }
        .sortable-ghost * { visibility: hidden; }

        .cell-add-btn { opacity: 0; transform: scale(0.9); transition: all 0.2s; }
        .group\/row:hover .cell-add-btn { opacity: 1; transform: scale(1); }

        .min-h-cell { min-height: 90px; }
        .app-title { user-select: none; }
        .month-divider { border-top: 3px solid #94A3B8 !important; }
        
        #error-console {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: #7f1d1d; color: #fecaca;
            font-family: monospace; font-size: 11px;
            padding: 8px; z-index: 9999;
            max-height: 100px; overflow-y: auto;
            display: none;
        }
        
        /* Modal Transitions */
        .modal-enter-active, .modal-leave-active { transition: opacity 0.2s; }
        .modal-enter-from, .modal-leave-to { opacity: 0; }
        .modal-enter-active .modal-card, .modal-leave-active .modal-card { transition: transform 0.2s; }
        .modal-enter-from .modal-card, .modal-leave-to .modal-card { transform: scale(0.95); }
    </style>
</head>
<body class="h-screen overflow-hidden flex flex-col bg-bg">

    <div id="error-console"></div>

    <div id="app" class="h-full flex flex-col" v-cloak>
        <!-- Header -->
        <header class="h-14 bg-slate-700 text-slate-50 flex items-center justify-between px-4 sm:px-6 shrink-0 z-50 shadow-md">
            <div class="flex items-center gap-3 cursor-pointer app-title group" @click="handleTitleClick">
                <div class="w-8 h-8 rounded-lg bg-slate-800 text-white flex items-center justify-center shadow-md border border-slate-600 group-hover:scale-105 transition-transform">
                    <i class="ph ph-kanban text-lg"></i>
                </div>
                <h1 class="font-bold text-lg tracking-tight text-white">Routy</h1>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-[10px] text-green-400 font-medium flex items-center gap-1.5 bg-green-900/30 px-2 py-1 rounded-full">
                    <i class="ph ph-check-circle"></i> オンライン
                </div>
                <button @click="openSetManagerModal" class="flex items-center gap-1.5 text-xs font-medium bg-slate-600 hover:bg-slate-500 border border-slate-500 px-3 py-1.5 rounded-lg transition shadow-sm text-slate-100 group">
                    <i class="ph ph-stack text-slate-300 group-hover:text-white transition-colors"></i> セット管理
                </button>
            </div>
        </header>

        <div class="flex-1 flex overflow-hidden">
            <!-- Main Content -->
            <main class="flex-1 flex flex-col overflow-hidden relative bg-slate-100">
                <!-- Back to Today Button -->
                <button @click="scrollToToday" class="absolute bottom-6 right-6 z-[60] bg-slate-800 text-white shadow-lg hover:bg-slate-700 w-12 h-12 rounded-full flex items-center justify-center transition-all hover:scale-105 border border-slate-600 group" title="今日に戻る">
                    <div class="flex flex-col items-center leading-none">
                        <span class="text-[10px] font-bold">Today</span>
                    </div>
                </button>

                <!-- 
                   Layout Update: 
                   Separated the header (columns & memos) from the scrollable calendar area.
                   This prevents the "content going under header" issue completely.
                -->
                
                <!-- Fixed Header Section (Columns & Memo) -->
                <div ref="headerContainer" class="flex-none shadow-md border-b-2 border-slate-300 z-30 bg-slate-50 overflow-hidden">
                     <div class="min-w-full">
                        <!-- Column Headers -->
                        <div class="flex border-b border-border bg-white">
                            <div class="w-[60px] shrink-0 border-r border-border bg-slate-50 flex items-end justify-center pb-2 sticky-date z-40 cursor-pointer hover:bg-slate-100 transition-colors group/date" title="日付ジャンプ" @click="openDatePicker">
                                <i class="ph ph-calendar-blank text-slate-400 text-xl group-hover/date:text-primary transition-colors"></i>
                                <input type="date" ref="datePickerInput" class="absolute inset-0 opacity-0 cursor-pointer" @change="onDateJump">
                            </div>
                            <div id="column-headers" class="flex flex-1 w-full">
                                <div v-for="col in columns" :key="col.id" :data-id="col.id" class="flex-1 min-w-[250px] border-r border-border px-3 py-3 bg-slate-50/50 group/col relative cursor-default">
                                    <div class="flex items-center gap-2">
                                        <div class="cursor-grab active:cursor-grabbing text-slate-300 hover:text-slate-500 column-handle shrink-0 transition-colors">
                                            <i class="ph ph-dots-six-vertical text-lg"></i>
                                        </div>
                                        <input v-model="col.title" @change="updateColumn(col)" class="bg-transparent font-bold text-slate-700 text-base truncate w-full focus:bg-white focus:outline-none focus:ring-2 focus:ring-primary/20 rounded px-2 py-0.5 transition-all">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Memo Area -->
                        <div class="flex bg-white relative z-30">
                            <div class="w-[60px] shrink-0 border-r border-border bg-slate-50 sticky-date z-40"></div>
                            <div v-for="col in columns" :key="col.id" class="flex-1 min-w-[250px] border-r border-border p-1.5">
                                <div class="text-[9px] font-bold text-slate-400 mb-1 pl-1 tracking-wide flex items-center gap-1">
                                     メモ
                                </div>
                                <div :id="`memo-area-${col.id}`" class="min-h-[10px] space-y-1 p-0.5 transition-all rounded-md" data-type="memo" :data-col="col.id">
                                    <div v-for="task in getMemoTasks(col.id)" :key="task.id" :data-id="task.id" class="task-card rounded px-1.5 py-1 text-xs cursor-grab group/card relative flex items-center justify-between gap-1 border border-slate-200 hover:border-primary/40 bg-white shadow-sm" @click="openTaskModal(null, col.id, null, task)">
                                        <div class="font-medium text-slate-700 leading-tight flex-1 truncate">{{ task.title }}</div>
                                        <div class="flex gap-1 shrink-0 opacity-0 group-hover/card:opacity-100 transition-opacity">
                                            <button @click.stop="quickAdd(task)" title="今日に追加" class="text-slate-400 hover:text-primary"><i class="ph ph-plus-circle text-sm"></i></button>
                                            <button @click.stop="deleteTask(task.id)" title="削除" class="text-slate-400 hover:text-red-500"><i class="ph ph-trash text-sm"></i></button>
                                        </div>
                                    </div>
                                </div>
                                <button @click="openMemoModal(col)" class="w-full py-0.5 text-center text-slate-500 border border-dashed border-slate-300 hover:border-primary/50 hover:text-primary hover:bg-slate-100 rounded text-[10px] transition-all mt-1" title="メモを追加">
                                    <i class="ph ph-plus"></i>
                                </button>
                            </div>
                        </div>
                     </div>
                </div>

                <!-- Scrollable Calendar Area -->
                <div ref="calendarContainer" class="flex-1 overflow-auto relative custom-scrollbar" @scroll="syncScroll">
                    <!-- Calendar Grid -->
                    <div class="min-w-full pb-24 bg-slate-100">
                        <div v-for="day in calendarDays" :key="day.dateStr" :id="`day-${day.dateStr}`" class="flex border-b border-border group/row min-h-cell transition-colors w-full" :class="{'bg-slate-50': !isToday(day.dateStr), 'bg-sky-50/40': isToday(day.dateStr), 'month-divider': day.dayNum === 1}">
                            <!-- Date Column -->
                            <div class="w-[60px] shrink-0 sticky-date flex flex-col items-center justify-start text-slate-500 text-xs border-r border-border z-20 transition-colors" :class="isToday(day.dateStr) ? 'bg-sky-50/50 text-sky-700 font-bold' : 'bg-slate-100'">
                                <div v-if="day.dayNum === 1" class="w-full bg-slate-300 text-[10px] text-center text-slate-700 font-bold py-1 mb-2 tracking-wide shadow-sm">{{ day.month }}月</div>
                                <div v-else class="h-3"></div>
                                <span class="text-[10px] uppercase font-bold tracking-wider leading-none mb-0.5 text-slate-400">{{ day.dayName }}</span>
                                <span class="text-xl font-light leading-none tracking-tight text-slate-700" :class="{'text-sky-600': isToday(day.dateStr)}">{{ day.dayNum }}</span>
                                <div v-if="isToday(day.dateStr)" class="absolute left-0 top-0 bottom-0 w-1 bg-sky-500 shadow-[2px_0_5px_rgba(14,165,233,0.3)]"></div>
                            </div>

                            <!-- Task Columns -->
                            <div v-for="col in columns" :key="col.id" class="flex-1 min-w-[250px] border-r border-border relative bg-transparent flex flex-col p-1.5 transition-colors">
                                <div :id="`cell-${col.id}-${day.dateStr}`" class="flex-1 w-full space-y-2 relative z-10" data-type="scheduled" :data-col="col.id" :data-date="day.dateStr">
                                    <!-- Loop modified to handle multi-day display -->
                                    <div v-for="task in getTasksForDay(col.id, day.dateStr)" :key="`${task.id}-${day.dateStr}`" :data-id="task.id" class="task-card rounded-lg px-2 py-1.5 text-xs group/card select-none relative flex flex-col gap-1 shadow-sm" :class="task.isGoal ? 'bg-white border-amber-300 bg-amber-50/50 border-l-[4px] border-l-amber-400' : 'bg-white border-slate-300'" @click="openTaskModal(day.dateStr, col.id, null, task)">
                                        <div class="font-medium text-slate-800 leading-snug flex items-start gap-1.5">
                                            <span v-if="task.isGoal" class="text-amber-500 flex-shrink-0 mt-0.5 drop-shadow-sm"><i class="ph ph-flag-banner-fill"></i></span>
                                            <span :class="{'text-amber-900': task.isGoal}">{{ task.title }}</span>
                                            
                                            <!-- Current/Total days badge -->
                                            <span v-if="task.totalDays > 1" class="text-[10px] font-bold text-slate-500 bg-slate-100 px-1.5 py-0.5 rounded flex items-center whitespace-nowrap ml-auto shrink-0 border border-slate-200">
                                                {{ task.currentDay }}/{{ task.totalDays }}
                                            </span>
                                        </div>
                                        <!-- Hover Controls (Only Delete) -->
                                        <div class="flex justify-end gap-1 opacity-0 group-hover/card:opacity-100 transition-opacity absolute bottom-1 right-1 bg-white/95 backdrop-blur-sm rounded-lg shadow-sm border border-slate-200 p-0.5">
                                            <button @click.stop="deleteTask(task.id)" title="削除" class="text-slate-400 hover:text-red-500 text-xs p-1 rounded hover:bg-red-50"><i class="ph ph-trash text-sm"></i></button>
                                        </div>
                                    </div>
                                </div>
                                <div @click="openTaskModal(day.dateStr, col.id)" class="h-6 -mt-1 mx-2 mb-1 rounded-full flex items-center justify-center cursor-pointer hover:bg-slate-200 cell-add-btn text-slate-300 hover:text-primary transition-all z-20 border border-transparent hover:border-slate-300">
                                    <i class="ph ph-plus text-sm"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Sidebar (Library) -->
            <aside class="w-[300px] lg:w-[360px] xl:w-[420px] 2xl:w-[480px] bg-slate-50 border-l border-border flex flex-col shrink-0 z-40 transition-all duration-300 shadow-xl" :class="{'translate-x-full absolute right-0 h-full': isMobile, 'relative': !isMobile}">
                <div class="h-14 border-b border-border bg-white px-5 flex items-center justify-between shrink-0">
                    <span class="font-bold text-slate-700 text-sm flex items-center gap-2"><i class="ph ph-books text-slate-400 text-lg"></i> ライブラリ</span>
                    <div class="flex items-center gap-2">
                        <button @click="openBulkAddModal" class="w-8 h-8 flex items-center justify-center text-xs bg-white border border-slate-300 text-slate-600 rounded-lg hover:bg-white hover:text-primary hover:border-primary/50 transition shadow-sm" title="一括登録">
                            <i class="ph ph-list-plus text-lg"></i>
                        </button>
                        <button @click="openLibraryAddModal" class="text-xs bg-white border border-slate-300 text-slate-600 hover:text-primary hover:border-primary/50 hover:bg-slate-50 px-3 py-1.5 rounded-lg font-medium transition shadow-sm flex items-center gap-1.5">
                            <i class="ph ph-plus text-sm"></i> 追加
                        </button>
                    </div>
                </div>
                
                <div class="flex-1 overflow-y-auto custom-scrollbar p-5 space-y-8 bg-slate-50">
                    <div v-for="col in columns" :key="col.id" class="space-y-2.5">
                        <!-- Accordion Header: uppercase removed -->
                        <div @click="toggleProject(col.id)" class="flex items-center justify-between text-[11px] font-bold text-slate-500 tracking-wider sticky top-0 bg-slate-50 py-1.5 z-10 border-b border-slate-200 cursor-pointer hover:text-primary transition">
                            <span class="truncate pr-2">{{ col.title }}</span>
                            <i class="ph" :class="expandedProjects[col.id] ? 'ph-caret-down' : 'ph-caret-right'"></i>
                        </div>
                        
                        <!-- Accordion Content -->
                        <div v-show="expandedProjects[col.id]" class="space-y-2" :id="`library-${col.id}`" data-type="library" :data-col="col.id">
                            <!-- Sets -->
                            <div v-for="set in getTaskSets(col.id)" :key="set.id" :data-id="set.id" @click="confirmApplySet(set)" class="bg-white border border-slate-200 rounded-xl p-2 shadow-sm hover:border-primary/40 hover:shadow-md cursor-pointer transition flex items-center justify-between gap-3 group relative overflow-hidden">
                                <div class="flex items-center gap-3 overflow-hidden relative z-10">
                                    <div class="w-8 h-8 rounded-lg bg-blue-50 text-primary flex items-center justify-center shrink-0 border border-blue-100"><i class="ph ph-stack-simple text-lg"></i></div>
                                    <div class="flex flex-col overflow-hidden">
                                        <div class="text-xs font-bold text-slate-700 truncate">{{ set.title }}</div>
                                    </div>
                                </div>
                                <div @click.stop="openSetManagerModal" class="w-7 h-7 rounded-full bg-slate-50 text-slate-400 flex items-center justify-center group-hover:bg-primary group-hover:text-white transition-all shadow-sm border border-slate-100 relative z-10">
                                    <i class="ph ph-pencil-simple text-sm"></i>
                                </div>
                            </div>

                            <!-- Library Tasks (Further Shrinked Height: py-1.5 -> py-0.5) -->
                            <div v-for="task in getLibraryTasks(col.id)" :key="task.id" :data-id="task.id" class="task-card rounded-lg px-2 py-0.5 text-xs group/card select-none relative flex items-center justify-between gap-3 border border-slate-200 hover:border-slate-300 bg-white" @click="openTaskModal(null, col.id, null, task)">
                                <div class="font-medium text-slate-700 leading-tight flex items-center gap-2 flex-1 truncate">
                                    <span v-if="task.isGoal" class="text-amber-500"><i class="ph ph-flag-banner-fill"></i></span>
                                    <span class="truncate">{{ task.title }}</span>
                                    <span v-if="task.range > 1" class="text-[10px] text-slate-400 bg-slate-50 px-1 rounded border border-slate-100">{{task.range}}日</span>
                                </div>
                                <div class="flex gap-1 shrink-0 opacity-0 group-hover/card:opacity-100 transition-opacity">
                                    <button @click.stop="quickAdd(task)" title="今日に追加(コピー)" class="text-slate-400 hover:text-primary"><i class="ph ph-plus-circle text-lg"></i></button>
                                    <button @click.stop="deleteTask(task.id)" title="削除" class="text-slate-400 hover:text-red-500"><i class="ph ph-trash text-lg"></i></button>
                                </div>
                            </div>
                        </div>
                        
                        <div v-show="expandedProjects[col.id] && getLibraryItems(col.id).length === 0" class="text-center text-[10px] text-slate-400 py-4 border border-dashed border-slate-200 rounded-xl bg-white/50">
                            なし
                        </div>
                    </div>
                </div>
            </aside>
        </div>

        <!-- Modals -->
        
        <!-- Task Modal -->
        <transition name="modal">
            <div v-if="modals.task" class="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4 backdrop-blur-sm" @click.self="modals.task = false">
                <div class="modal-card bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden flex flex-col">
                    <div class="h-12 border-b border-slate-100 flex items-center justify-between px-4 shrink-0 bg-slate-50/50">
                        <span class="font-bold text-slate-700 text-sm">{{ editingTask ? 'タスク編集' : 'タスク追加' }}</span>
                        <button @click="modals.task = false" class="text-slate-400 hover:text-slate-600"><i class="ph ph-x text-lg"></i></button>
                    </div>
                    <div class="p-5 space-y-4">
                        <div>
                            <label class="text-xs font-bold text-slate-500 mb-1 block">タイトル</label>
                            <input ref="taskTitleInput" v-model="taskForm.title" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary" placeholder="タスク名を入力..." @keyup.enter="saveTask">
                        </div>
                        <!-- Library items only show title and project selection -->
                        <div class="grid grid-cols-2 gap-3" v-if="!taskForm.inLibrary">
                            <div>
                                <label class="text-xs font-bold text-slate-500 mb-1 block">日付</label>
                                <input type="date" v-model="taskForm.date" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary text-slate-600">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-500 mb-1 block">プロジェクト</label>
                                <select v-model="taskForm.columnId" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary text-slate-600 bg-white">
                                    <option v-for="col in columns" :key="col.id" :value="col.id">{{ col.title }}</option>
                                </select>
                            </div>
                        </div>
                        <div v-else>
                            <!-- Library mode project selection -->
                            <label class="text-xs font-bold text-slate-500 mb-1 block">プロジェクト</label>
                            <select v-model="taskForm.columnId" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary text-slate-600 bg-white">
                                <option v-for="col in columns" :key="col.id" :value="col.id">{{ col.title }}</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-2 gap-3" v-if="!taskForm.inLibrary">
                            <div>
                                <label class="text-xs font-bold text-slate-500 mb-1 block">期間 (日数)</label>
                                <input type="number" min="1" v-model="taskForm.range" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary">
                            </div>
                            <div class="flex items-end pb-2">
                                <label class="flex items-center gap-2 cursor-pointer select-none">
                                    <input type="checkbox" v-model="taskForm.isGoal" class="w-4 h-4 text-amber-500 rounded border-slate-300 focus:ring-amber-500">
                                    <span class="text-sm text-slate-600">ゴール設定</span>
                                </label>
                            </div>
                        </div>
                        <div v-if="!editingTask && !taskForm.inLibrary" class="bg-slate-50 p-3 rounded-lg border border-slate-100">
                            <label class="flex items-center gap-2 cursor-pointer select-none">
                                <input type="checkbox" v-model="taskForm.saveToLibrary" class="w-4 h-4 text-primary rounded border-slate-300 focus:ring-primary">
                                <span class="text-xs font-medium text-slate-600">ライブラリにも保存する</span>
                            </label>
                        </div>
                    </div>
                    <div class="p-3 border-t border-slate-100 bg-slate-50 flex justify-end gap-2">
                        <button v-if="editingTask" @click="deleteTask(editingTask.id)" class="px-3 py-1.5 text-xs font-medium text-red-500 hover:bg-red-50 rounded-lg mr-auto">削除</button>
                        <button @click="modals.task = false" class="px-4 py-2 text-xs font-medium text-slate-600 hover:bg-slate-200 rounded-lg">キャンセル</button>
                        <button @click="saveTask" class="px-4 py-2 text-xs font-medium bg-primary text-white hover:bg-blue-600 rounded-lg shadow-sm shadow-blue-200">保存</button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- Memo Modal -->
        <transition name="modal">
            <div v-if="modals.memo" class="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4 backdrop-blur-sm" @click.self="modals.memo = false">
                <div class="modal-card bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden">
                    <div class="p-5 space-y-4">
                        <h3 class="font-bold text-slate-700 text-sm flex items-center gap-2">
                            <i class="ph ph-note-pencil text-slate-400"></i> メモ追加: {{ memoForm.columnTitle }}
                        </h3>
                        <input ref="memoTitleInput" v-model="memoForm.title" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary" placeholder="内容を入力..." @keyup.enter="saveMemo">
                    </div>
                    <div class="p-3 border-t border-slate-100 bg-slate-50 flex justify-end gap-2">
                        <button @click="modals.memo = false" class="px-4 py-2 text-xs font-medium text-slate-600 hover:bg-slate-200 rounded-lg">キャンセル</button>
                        <button @click="saveMemo" class="px-4 py-2 text-xs font-medium bg-primary text-white hover:bg-blue-600 rounded-lg shadow-sm">追加</button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- Library Add Modal -->
        <transition name="modal">
            <div v-if="modals.libraryAdd" class="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4 backdrop-blur-sm" @click.self="modals.libraryAdd = false">
                <div class="modal-card bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden">
                    <div class="p-5 space-y-4">
                        <h3 class="font-bold text-slate-700 text-sm flex items-center gap-2">
                            <i class="ph ph-books text-slate-400"></i> ライブラリに追加
                        </h3>
                        <input ref="libraryTitleInput" v-model="libraryForm.title" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary" placeholder="タスク名..." @keyup.enter="saveLibraryItem">
                        <select v-model="libraryForm.columnId" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary text-slate-600 bg-white">
                            <option v-for="col in columns" :key="col.id" :value="col.id">{{ col.title }}</option>
                        </select>
                    </div>
                    <div class="p-3 border-t border-slate-100 bg-slate-50 flex justify-end gap-2">
                        <button @click="modals.libraryAdd = false" class="px-4 py-2 text-xs font-medium text-slate-600 hover:bg-slate-200 rounded-lg">キャンセル</button>
                        <button @click="saveLibraryItem" class="px-4 py-2 text-xs font-medium bg-primary text-white hover:bg-blue-600 rounded-lg shadow-sm">追加</button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- Bulk Add Modal -->
        <transition name="modal">
            <div v-if="modals.bulkAdd" class="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4 backdrop-blur-sm" @click.self="modals.bulkAdd = false">
                <div class="modal-card bg-white rounded-xl shadow-2xl w-full max-w-md h-[500px] flex flex-col overflow-hidden">
                    <div class="h-12 border-b border-slate-100 flex items-center justify-between px-4 shrink-0">
                        <span class="font-bold text-slate-700 text-sm">一括登録</span>
                        <button @click="modals.bulkAdd = false" class="text-slate-400 hover:text-slate-600"><i class="ph ph-x text-lg"></i></button>
                    </div>
                    <div class="p-4 flex-1 flex flex-col gap-4">
                        <select v-model="bulkForm.columnId" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary text-slate-600 bg-white">
                            <option v-for="col in columns" :key="col.id" :value="col.id">{{ col.title }}</option>
                        </select>
                        <textarea ref="bulkTextInput" v-model="bulkForm.text" class="flex-1 w-full border border-slate-200 rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary resize-none" placeholder="タスクを改行区切りで入力してください..."></textarea>
                    </div>
                    <div class="p-3 border-t border-slate-100 bg-slate-50 flex justify-end gap-2">
                        <button @click="modals.bulkAdd = false" class="px-4 py-2 text-xs font-medium text-slate-600 hover:bg-slate-200 rounded-lg">キャンセル</button>
                        <button @click="saveBulkTasks" class="px-4 py-2 text-xs font-medium bg-primary text-white hover:bg-blue-600 rounded-lg shadow-sm">登録</button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- Set Manager Modal -->
        <transition name="modal">
            <div v-if="modals.setManager" class="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4 backdrop-blur-sm" @click.self="modals.setManager = false">
                <div class="modal-card bg-white rounded-xl shadow-2xl w-full max-w-3xl h-[600px] flex flex-col overflow-hidden">
                    <div class="h-14 border-b border-slate-100 flex items-center justify-between px-5 shrink-0 bg-slate-50">
                        <h2 class="font-bold text-slate-700">セット管理</h2>
                        <button @click="modals.setManager = false" class="text-slate-400 hover:text-slate-600"><i class="ph ph-x text-lg"></i></button>
                    </div>
                    <div class="flex-1 flex overflow-hidden">
                        <!-- Sidebar: List of Sets -->
                        <div class="w-1/3 border-r border-slate-100 bg-slate-50 flex flex-col">
                            <div class="p-3 border-b border-slate-100">
                                <button @click="createNewSet" class="w-full py-2 bg-white border border-slate-200 text-slate-600 rounded-lg text-xs font-bold hover:text-primary hover:border-primary/50 shadow-sm transition">
                                    <i class="ph ph-plus mr-1"></i> 新規作成
                                </button>
                            </div>
                            <div class="flex-1 overflow-y-auto p-2 space-y-1">
                                <div v-for="set in taskSets" :key="set.id" @click="selectSet(set)" class="px-3 py-2.5 rounded-lg text-sm cursor-pointer border hover:shadow-sm transition" :class="selectedSet && selectedSet.id === set.id ? 'bg-white border-primary/30 text-primary font-bold shadow-sm' : 'border-transparent hover:bg-white hover:border-slate-200 text-slate-600'">
                                    {{ set.title }}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Main: Editor -->
                        <div class="flex-1 flex flex-col bg-white" v-if="selectedSet">
                            <div class="p-5 border-b border-slate-100 flex flex-col gap-4">
                                <div>
                                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wide mb-1 block">セット名</label>
                                    <input v-model="selectedSet.title" class="w-full text-lg font-bold text-slate-700 border-b border-slate-200 focus:border-primary focus:outline-none py-1 placeholder-slate-300" placeholder="セット名">
                                </div>
                                <div>
                                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wide mb-1 block">プロジェクト</label>
                                    <select v-model="selectedSet.columnId" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/20 bg-white">
                                        <option v-for="col in columns" :key="col.id" :value="col.id">{{ col.title }}</option>
                                    </select>
                                </div>
                            </div>
                            <div class="flex-1 overflow-y-auto p-5 bg-slate-50/50">
                                <div id="sortable-set-list" class="space-y-2">
                                    <div v-for="(task, idx) in selectedSet.tasks" :key="idx" class="bg-white border border-slate-200 rounded-lg p-3 flex items-center gap-3 shadow-sm group">
                                        <div class="text-slate-300 cursor-grab active:cursor-grabbing handle shrink-0"><i class="ph ph-dots-six-vertical text-lg"></i></div>
                                        <div class="flex-1 grid grid-cols-12 gap-3 items-center">
                                            <div class="col-span-5">
                                                <input v-model="task.title" class="w-full text-sm font-medium text-slate-700 border-none focus:ring-0 p-0 placeholder-slate-300" placeholder="タスク名">
                                            </div>
                                            <div class="col-span-7 flex items-center justify-end gap-2">
                                                <!-- UPDATED: Toggle button logic -->
                                                <template v-if="task.isGoal">
                                                     <span class="text-xs font-bold text-amber-500 bg-amber-50 px-2 py-1 rounded border border-amber-100 flex items-center gap-1"><i class="ph ph-flag-banner-fill"></i> GOAL</span>
                                                </template>
                                                <template v-else>
                                                    <div class="flex items-center gap-1">
                                                        <span class="text-[10px] text-slate-400">前</span>
                                                        <input type="number" v-model="task.offset" class="w-10 text-center border border-slate-200 rounded text-xs py-1" min="1">
                                                        <span class="text-[10px] text-slate-400">日</span>
                                                    </div>
                                                    <button 
                                                        @click="setGoal(idx)" 
                                                        class="text-[10px] px-3 py-1.5 rounded-lg border transition-all flex items-center justify-center font-bold whitespace-nowrap min-w-[50px]"
                                                        :class="task.isGoal 
                                                            ? 'bg-amber-100 text-amber-700 border-amber-200 shadow-sm' 
                                                            : 'bg-white text-slate-400 border-slate-200 hover:border-slate-300 hover:text-slate-600'"
                                                    >
                                                        ゴール
                                                    </button>
                                                </template>
                                                <button @click="selectedSet.tasks.splice(idx, 1)" class="text-slate-400 hover:text-red-500 p-1 shrink-0 ml-1"><i class="ph ph-trash text-lg"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <button @click="addTaskToSet" class="w-full py-2 mt-4 border border-dashed border-slate-300 text-slate-400 rounded-lg hover:bg-white hover:text-primary hover:border-primary/50 transition flex items-center justify-center gap-2 text-xs font-bold">
                                    <i class="ph ph-plus"></i> タスクを追加
                                </button>
                            </div>
                            <div class="p-4 border-t border-slate-100 bg-white flex justify-between items-center">
                                <button v-if="selectedSet.id" @click="deleteSet" class="text-red-500 text-xs font-medium hover:bg-red-50 px-3 py-2 rounded-lg transition">セットを削除</button>
                                <div class="flex gap-2 ml-auto">
                                    <button @click="modals.setManager = false" class="px-4 py-2 text-xs font-medium text-slate-600 hover:bg-slate-100 rounded-lg">閉じる</button>
                                    <button @click="saveSet" class="px-5 py-2 text-xs font-bold bg-slate-800 text-white hover:bg-slate-700 rounded-lg shadow-lg shadow-slate-200">保存</button>
                                </div>
                            </div>
                        </div>
                        <div v-else class="flex-1 flex flex-col items-center justify-center text-slate-400 gap-3 bg-slate-50/30">
                            <i class="ph ph-stack text-4xl opacity-30"></i>
                            <span class="text-xs font-medium">左側のリストからセットを選択するか<br>新規作成してください</span>
                        </div>
                    </div>
                </div>
            </div>
        </transition>

        <!-- Apply Set Modal -->
        <transition name="modal">
            <div v-if="modals.applySet" class="fixed inset-0 bg-black/50 z-[70] flex items-center justify-center p-4 backdrop-blur-sm" @click.self="modals.applySet = false">
                <div class="modal-card bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden">
                    <div class="p-5 space-y-4">
                        <h3 class="font-bold text-slate-700 text-sm flex items-center gap-2">
                            <i class="ph ph-calendar-plus text-primary"></i> タスクセットを追加
                        </h3>
                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-100 text-xs text-slate-600">
                            <span class="font-bold">{{ selectedSet?.title }}</span> をカレンダーに追加します。
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-500 mb-1 block">ゴール日 (基準日)</label>
                            <input type="date" v-model="applySetDate" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary text-slate-600">
                            <p class="text-[10px] text-slate-400 mt-1">※ この日を基準に逆算してタスクが配置されます</p>
                        </div>
                    </div>
                    <div class="p-3 border-t border-slate-100 bg-slate-50 flex justify-end gap-2">
                        <button @click="modals.applySet = false" class="px-4 py-2 text-xs font-medium text-slate-600 hover:bg-slate-200 rounded-lg">キャンセル</button>
                        <button @click="applySetToCalendar" class="px-4 py-2 text-xs font-medium bg-primary text-white hover:bg-blue-600 rounded-lg shadow-sm">追加</button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- Delete Confirm Modal -->
        <transition name="modal">
            <div v-if="modals.deleteConfirm" class="fixed inset-0 bg-black/50 z-[80] flex items-center justify-center p-4 backdrop-blur-sm" @click.self="modals.deleteConfirm = false">
                <div class="modal-card bg-white rounded-xl shadow-2xl w-full max-w-xs overflow-hidden">
                    <div class="p-6 text-center">
                        <div class="w-12 h-12 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-3">
                            <i class="ph ph-trash text-2xl"></i>
                        </div>
                        <h3 class="font-bold text-slate-700 mb-1">本当に削除しますか？</h3>
                        <p class="text-xs text-slate-500">この操作は元に戻せません。</p>
                    </div>
                    <div class="p-3 border-t border-slate-100 bg-slate-50 flex justify-center gap-2">
                        <button @click="modals.deleteConfirm = false" class="px-4 py-2 text-xs font-medium text-slate-600 hover:bg-slate-200 rounded-lg">キャンセル</button>
                        <button @click="executeDelete" class="px-4 py-2 text-xs font-medium bg-red-500 text-white hover:bg-red-600 rounded-lg shadow-sm">削除する</button>
                    </div>
                </div>
            </div>
        </transition>

    </div>

    <script>
        const { createApp, ref, nextTick, onMounted, watch } = Vue;

        const firebaseConfig = {
            apiKey: "AIzaSyAk1Arqv1Tzdajt1_qRnZ09F8MoSYpWGWc",
            authDomain: "routy-4998b.firebaseapp.com",
            projectId: "routy-4998b",
            storageBucket: "routy-4998b.firebasestorage.app",
            messagingSenderId: "483733734059",
            appId: "1:483733734059:web:2ae5e39a1a7ca325522dee"
        };
        
        window.onerror = function(message, source, lineno, colno, error) {
            const el = document.getElementById('error-console');
            if(el) {
                el.style.display = 'block';
                el.innerHTML += `<div>[Error] ${message} (Line ${lineno})</div>`;
            }
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Add Anonymous Auth for GitHub Pages support
        firebase.auth().signInAnonymously().catch((error) => {
            console.error("Auth Error:", error);
        });

        createApp({
            setup() {
                const loading = ref(false);
                const columns = ref([]);
                const tasks = ref([]);
                const taskSets = ref([]);
                const calendarDays = ref([]);
                const isMobile = ref(window.innerWidth < 640);
                const modals = ref({ task: false, setManager: false, applySet: false, bulkAdd: false, memo: false, libraryAdd: false, deleteConfirm: false });
                const editingTask = ref(null);
                const taskForm = ref({ title: '', date: '', columnId: '', range: 1, saveToLibrary: false, isGoal: false });
                const bulkForm = ref({ text: '', columnId: '', target: 'library' });
                const memoForm = ref({ title: '', columnId: '', columnTitle: '' });
                const libraryForm = ref({ title: '', columnId: '' });
                const taskTitleInput = ref(null);
                const memoTitleInput = ref(null);
                const libraryTitleInput = ref(null);
                const bulkTextInput = ref(null);
                const datePickerInput = ref(null);
                const selectedSet = ref(null);
                const applySetDate = ref(dayjs().format('YYYY-MM-DD'));
                const deleteTarget = ref(null);
                const deleteAction = ref(null);
                const expandedProjects = ref({});

                const headerContainer = ref(null);
                const calendarContainer = ref(null);

                const getColumnTitle = (id) => columns.value.find(c => c.id === id)?.title || '';
                const isToday = (d) => d === dayjs().format('YYYY-MM-DD');
                const getDayDiff = (s, c) => dayjs(c).diff(dayjs(s), 'day');
                
                // --- 期間表示のロジック修正 ---
                const getTasksForDay = (c, d) => {
                    return tasks.value.reduce((acc, t) => {
                        if (t.columnId !== c || !t.date) return acc;
                        
                        const diff = dayjs(d).diff(dayjs(t.date), 'day');
                        const range = t.range && t.range > 1 ? t.range : 1;

                        if (diff >= 0 && diff < range) {
                            // 表示用にオブジェクトを拡張（元のオブジェクトは変更しない）
                            acc.push({
                                ...t,
                                currentDay: diff + 1,
                                totalDays: range
                            });
                        }
                        return acc;
                    }, []);
                };
                
                const getMemoTasks = (c) => tasks.value.filter(t => t.columnId === c && !t.date && !t.inLibrary);
                const getLibraryTasks = (c) => tasks.value.filter(t => t.columnId === c && t.inLibrary === true);
                const getTaskSets = (c) => taskSets.value.filter(s => s.columnId === c);
                const getLibraryItems = (c) => [...getTaskSets(c), ...getLibraryTasks(c)];

                const initCalendar = () => {
                    const start = dayjs().subtract(7, 'day'); // Start from a week ago
                    const diffDays = dayjs().diff(start, 'day');
                    const totalDays = Math.max(diffDays + 90, 120); 
                    const days = [];
                    for (let i = 0; i < totalDays; i++) {
                        const d = start.add(i, 'day');
                        days.push({ dateStr: d.format('YYYY-MM-DD'), dayNum: d.date(), dayName: d.format('ddd'), month: d.month() + 1, index: i });
                    }
                    calendarDays.value = days;
                    nextTick(() => {
                        // Scroll logic updated: use calendarContainer instead of global window scroll
                        const yesterdayStr = dayjs().subtract(1, 'day').format('YYYY-MM-DD');
                        const el = document.getElementById(`day-${yesterdayStr}`);
                        const container = calendarContainer.value;
                        
                        if(el && container) {
                            // Since header is separated, we just scroll to the element's offsetTop within the container
                            container.scrollTop = el.offsetTop;
                        } else if (container) {
                            // Fallback
                            const todayIndex = 7;
                            container.scrollTop = (todayIndex - 1) * 91;
                        }
                    });
                };

                const openDatePicker = () => datePickerInput.value?.showPicker();
                const onDateJump = (e) => {
                    const el = document.getElementById(`day-${e.target.value}`);
                    if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    else alert('範囲外です');
                };

                const scrollToToday = () => {
                    // Previous logic: center today
                    // const todayStr = dayjs().format('YYYY-MM-DD');
                    // const el = document.getElementById(`day-${todayStr}`);
                    // if (el) {
                    //     el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // }

                    // New logic: match initCalendar (scroll to yesterday at top)
                    const yesterdayStr = dayjs().subtract(1, 'day').format('YYYY-MM-DD');
                    const el = document.getElementById(`day-${yesterdayStr}`);
                    const container = calendarContainer.value;
                    
                    if(el && container) {
                        container.scrollTo({
                            top: el.offsetTop,
                            behavior: 'smooth'
                        });
                    }
                };

                const syncScroll = () => {
                    if (headerContainer.value && calendarContainer.value) {
                        headerContainer.value.scrollLeft = calendarContainer.value.scrollLeft;
                    }
                };

                const loadData = () => {
                    loading.value = true;
                    // Ensure Auth is ready before querying if possible, but snaphot listener will handle it when connection opens
                    db.collection("columns").orderBy("order").onSnapshot(snap => {
                        if(snap.empty) {
                            const batch = db.batch();
                            [{ id: 'c1', title: 'PROJECT A', order: 1 }, { id: 'c2', title: 'PROJECT B', order: 2 }, { id: 'c3', title: 'OTHER WORKS', order: 3 }].forEach(c => batch.set(db.collection("columns").doc(c.id), c));
                            batch.commit();
                        } else {
                            columns.value = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                            // Initialize expanded state for all columns to true (open) by default
                            columns.value.forEach(col => {
                                if (expandedProjects.value[col.id] === undefined) {
                                    expandedProjects.value[col.id] = true;
                                }
                            });
                        }
                    }, handleError);
                    db.collection("tasks").onSnapshot(snap => tasks.value = snap.docs.map(d => ({ id: d.id, ...d.data() })), handleError);
                    db.collection("taskSets").onSnapshot(snap => { taskSets.value = snap.docs.map(d => ({ id: d.id, ...d.data() })); loading.value = false; }, handleError);
                };

                const handleError = (e) => { 
                    if (e.code === 'permission-denied') console.error("権限エラー: Firestoreルールを確認してください"); 
                    else console.error(e);
                };

                const toggleProject = (colId) => {
                    expandedProjects.value[colId] = !expandedProjects.value[colId];
                };

                const initSortable = () => {
                    const colEl = document.getElementById('column-headers');
                    if (colEl) new Sortable(colEl, { animation: 150, handle: '.column-handle', onEnd: (evt) => {
                        const newOrder = [...columns.value];
                        const item = newOrder.splice(evt.oldIndex, 1)[0];
                        newOrder.splice(evt.newIndex, 0, item);
                        const batch = db.batch();
                        newOrder.forEach((col, idx) => batch.update(db.collection("columns").doc(col.id), { order: idx + 1 }));
                        batch.commit();
                    }});
                    columns.value.forEach(col => {
                        const memoEl = document.getElementById(`memo-area-${col.id}`);
                        if (memoEl) new Sortable(memoEl, { group: 'tasks', animation: 150, ghostClass: 'sortable-ghost', delay: 100, delayOnTouchOnly: true, onEnd: onDragEnd });
                        const libEl = document.getElementById(`library-${col.id}`);
                        if (libEl) new Sortable(libEl, { group: { name: 'tasks', pull: 'clone', put: false }, sort: true, animation: 150, ghostClass: 'sortable-ghost', delay: 100, delayOnTouchOnly: true });
                    });
                    calendarDays.value.forEach(day => {
                        columns.value.forEach(col => {
                            const el = document.getElementById(`cell-${col.id}-${day.dateStr}`);
                            if (el) new Sortable(el, {
                                group: 'tasks', animation: 150, ghostClass: 'sortable-ghost', delay: 100, delayOnTouchOnly: true,
                                onAdd: (evt) => {
                                    if (evt.from.getAttribute('data-type') === 'library') {
                                        // 変更点: remove()ではなくdisplay:noneにする
                                        // evt.item.remove(); 
                                        evt.item.style.display = 'none';
                                        
                                        const originalId = evt.item.getAttribute('data-id');
                                        const s = tasks.value.find(t => t.id === originalId);
                                        if (s) db.collection("tasks").add({ title: s.title, columnId: col.id, date: day.dateStr, range: s.range, isGoal: false, inLibrary: false, createdAt: new Date() });
                                    }
                                },
                                onEnd: onDragEnd
                            });
                        });
                    });
                };

                const onDragEnd = (evt) => {
                    if (evt.from.getAttribute('data-type') === 'library') return;
                    const id = evt.item.getAttribute('data-id');
                    const c = evt.to.getAttribute('data-col');
                    const d = evt.to.getAttribute('data-date') || null;
                    const type = evt.to.getAttribute('data-type');
                    if (id && c) {
                        const upd = { columnId: c, date: d };
                        if (type === 'memo') upd.inLibrary = false;
                        db.collection("tasks").doc(id).update(upd);
                    }
                };

                watch([columns, tasks], () => nextTick(initSortable));

                const openTaskModal = (d, c, u, t) => {
                    if (t) { 
                        editingTask.value = t; 
                        taskForm.value = { ...t, saveToLibrary: false }; 
                    } else { 
                        editingTask.value = null; 
                        // Set inLibrary: false explicitly for new tasks from calendar
                        taskForm.value = { title: '', date: d || '', columnId: c || columns.value[0]?.id, range: 1, saveToLibrary: false, isGoal: false, inLibrary: false }; 
                    }
                    modals.value.task = true;
                    nextTick(() => taskTitleInput.value?.focus());
                };
                
                const saveTask = async () => {
                    if (!taskForm.value.title || !taskForm.value.title.trim()) return;
                    const data = { ...taskForm.value, range: parseInt(taskForm.value.range), inLibrary: false };
                    delete data.saveToLibrary;
                    
                    // If editing a library item, preserve inLibrary status
                    if (taskForm.value.inLibrary) {
                        data.inLibrary = true;
                    }

                    if (editingTask.value) { await db.collection("tasks").doc(editingTask.value.id).update(data); }
                    else {
                        const newDoc = { ...data, createdAt: new Date() };
                        if (!newDoc.date) newDoc.date = null;
                        const res = await db.collection("tasks").add(newDoc);
                        if (taskForm.value.saveToLibrary && taskForm.value.date) { await db.collection("tasks").add({ ...newDoc, date: null, inLibrary: true }); }
                    }
                    modals.value.task = false;
                };

                const confirmDelete = (type, target) => {
                    deleteAction.value = type;
                    deleteTarget.value = target;
                    modals.value.deleteConfirm = true;
                };

                const executeDelete = async () => {
                    if (!deleteTarget.value) return;
                    if (deleteAction.value === 'task') {
                        await db.collection("tasks").doc(deleteTarget.value.id).delete();
                    } else if (deleteAction.value === 'set') {
                        await db.collection("taskSets").doc(deleteTarget.value.id).delete();
                        selectedSet.value = null;
                    }
                    modals.value.deleteConfirm = false;
                    modals.value.task = false;
                    modals.value.setManager = false; 
                };

                const deleteTask = (id) => confirmDelete('task', { id });
                const deleteSet = () => confirmDelete('set', selectedSet.value);

                const openMemoModal = (c) => { memoForm.value = { title: '', columnId: c.id, columnTitle: c.title }; modals.value.memo = true; nextTick(() => memoTitleInput.value?.focus()); };
                const saveMemo = async () => { if (!memoForm.value.title.trim()) return; await db.collection("tasks").add({ title: memoForm.value.title, columnId: memoForm.value.columnId, date: null, range: 1, isGoal: false, inLibrary: false, createdAt: new Date() }); modals.value.memo = false; };
                const openLibraryAddModal = () => { libraryForm.value = { title: '', columnId: columns.value[0]?.id }; modals.value.libraryAdd = true; nextTick(() => libraryTitleInput.value?.focus()); };
                const saveLibraryItem = async () => { if (!libraryForm.value.title.trim()) return; await db.collection("tasks").add({ title: libraryForm.value.title, columnId: libraryForm.value.columnId, date: null, range: 1, isGoal: false, inLibrary: true, createdAt: new Date() }); modals.value.libraryAdd = false; };
                const openBulkAddModal = () => { bulkForm.value = { text: '', columnId: columns.value[0]?.id }; modals.value.bulkAdd = true; nextTick(() => bulkTextInput.value?.focus()); };
                const saveBulkTasks = async () => {
                    const lines = bulkForm.value.text.split('\n').map(l => l.trim()).filter(l => l);
                    if (!lines.length) return;
                    const batch = db.batch();
                    lines.forEach(l => batch.set(db.collection("tasks").doc(), { title: l, columnId: bulkForm.value.columnId, date: null, range: 1, isGoal: false, inLibrary: true, createdAt: new Date() }));
                    await batch.commit(); modals.value.bulkAdd = false;
                };

                const openSetManagerModal = () => { modals.value.setManager = true; selectedSet.value = null; };
                const createNewSet = () => { selectedSet.value = { title: '新しいセット', columnId: columns.value[0]?.id, tasks: [{ title: 'ゴール', isGoal: true, columnId: columns.value[0]?.id, offset: 0 }] }; setupSetSortable(); };
                const selectSet = (set) => { selectedSet.value = JSON.parse(JSON.stringify(set)); setupSetSortable(); };
                const setupSetSortable = () => { nextTick(() => { const el = document.getElementById('sortable-set-list'); if (el) new Sortable(el, { animation: 150, handle: '.handle', onEnd: (evt) => { const item = selectedSet.value.tasks.splice(evt.oldIndex, 1)[0]; selectedSet.value.tasks.splice(evt.newIndex, 0, item); }}); }); };
                const addTaskToSet = () => selectedSet.value.tasks.push({ title: '', isGoal: false, columnId: selectedSet.value.columnId, offset: 1 });
                const setGoal = (idx) => selectedSet.value.tasks.forEach((t, i) => { t.isGoal = (i === idx); if(t.isGoal) t.offset = 0; });
                const saveSet = async () => { if (selectedSet.value.id) await db.collection("taskSets").doc(selectedSet.value.id).update(selectedSet.value); else await db.collection("taskSets").add(selectedSet.value); selectedSet.value = null; };
                
                const confirmApplySet = (set) => { selectedSet.value = JSON.parse(JSON.stringify(set)); applySetDate.value = dayjs().format('YYYY-MM-DD'); modals.value.applySet = true; };
                const applySetToCalendar = async () => {
                    const goal = dayjs(applySetDate.value);
                    const batch = db.batch();
                    selectedSet.value.tasks.forEach(t => { const d = t.isGoal ? goal : goal.subtract(parseInt(t.offset), 'day'); batch.set(db.collection("tasks").doc(), { title: t.title, columnId: t.columnId, date: d.format('YYYY-MM-DD'), range: 1, isGoal: t.isGoal, inLibrary: false, createdAt: new Date() }); });
                    await batch.commit(); modals.value.applySet = false; modals.value.setManager = false;
                };

                const updateColumn = async (col) => await db.collection("columns").doc(col.id).update({ title: col.title });
                const quickAdd = async (t) => await db.collection("tasks").add({ title: t.title, columnId: t.columnId, date: dayjs().format('YYYY-MM-DD'), range: t.range, isGoal: false, inLibrary: false, createdAt: new Date() });
                const returnToLibrary = async (t) => { if(confirm('メモに戻しますか？')) await db.collection("tasks").doc(t.id).update({ date: null, inLibrary: false }); };
                const handleTitleClick = (e) => { if (e.detail === 3) { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([document.documentElement.outerHTML], { type: 'text/html' })); a.download = `routy_backup_${dayjs().format('YYYYMMDD_HHmm')}.html`; a.click(); } };

                onMounted(() => { 
                    initCalendar(); 
                    loadData(); 
                    window.addEventListener('resize', () => { isMobile.value = window.innerWidth < 640; });
                });

                return {
                    loading, columns, tasks, taskSets, calendarDays, modals, editingTask, taskForm, bulkForm, memoForm, libraryForm,
                    taskTitleInput, memoTitleInput, libraryTitleInput, bulkTextInput, datePickerInput, isMobile,
                    selectedSet, applySetDate, deleteTarget, deleteAction, expandedProjects,
                    headerContainer, calendarContainer, syncScroll,
                    openTaskModal, saveTask, deleteTask, openMemoModal, saveMemo, openLibraryAddModal, saveLibraryItem,
                    openBulkAddModal, saveBulkTasks, openSetManagerModal, createNewSet, selectSet, addTaskToSet, setGoal, saveSet, deleteSet,
                    confirmApplySet, applySetToCalendar, updateColumn, quickAdd, returnToLibrary, toggleProject,
                    getTasksForDay, getMemoTasks, getLibraryTasks, getLibraryItems, getTaskSets, getColumnTitle,
                    isToday, getDayDiff, openDatePicker, onDateJump, scrollToToday, handleTitleClick, confirmDelete, executeDelete
                };
            }
        }).mount('#app');
    </script>

</body>
</html>